---
title: "Situación problema: Transporte en México"
author: "Miguel Ángel Rivas Torres , Ana Carolina T. Villegas , Ángel David Lugo Lafarga"
format:
  html:
    toc: true
    html-math-method: katex
    embed-resources: true
    self-contained-math: true
    df-print: kable
---

## **Situación problema: Transporte en México**

```{r}
library (bnlearn)
```

```{r}
data <- read.csv("~/SP_INEGI/data/clean/Base_Discretizada.csv",
                 stringsAsFactors = TRUE)

head(data)
```

```{r}
names(data)
```

```{r}
data$TPUBLICO <- with(data, 
  (uso_micro | uso_taxi_calle | uso_metro | uso_rtp_m1 | uso_autobus |
   uso_trolebus | uso_metrobus_mexibus | uso_tren_ligero |
   uso_tren_suburbano | uso_mexicable) * 1
)

data[] <- lapply(data, as.factor)


head(data)
```

```{r}
data_dag <- data[, c("MUJER","EDAD_20_45","EDAD_GE60","EDAD_GT30",
           "ESTRATO_ALTO","ESTRATO_MA","LOC_LT15K","LOC_GT100K",
           "ENT13","mun","TRABAJO","SEMANA",
           "AUTOS_GT1","AUTOS_2PLUS","TPUBLICO")]

```

```{r}
dag1 = empty.graph(nodes = c("MUJER","EDAD_20_45","EDAD_GE60","EDAD_GT30",
           "ESTRATO_ALTO","ESTRATO_MA","LOC_LT15K","LOC_GT100K",
           "ENT13","mun","TRABAJO","SEMANA",
           "AUTOS_GT1","AUTOS_2PLUS","TPUBLICO") )
```

```{r}
dag2 = empty.graph(nodes = c("MUJER","EDAD_20_45","EDAD_GE60","EDAD_GT30",
           "ESTRATO_ALTO","ESTRATO_MA","LOC_LT15K","LOC_GT100K",
           "ENT13","mun","TRABAJO","SEMANA",
           "AUTOS_GT1","AUTOS_2PLUS","TPUBLICO"))
```

```{r}
dag3 = empty.graph(nodes = c("MUJER","EDAD_20_45","EDAD_GE60","EDAD_GT30",
           "ESTRATO_ALTO","ESTRATO_MA","LOC_LT15K","LOC_GT100K",
           "ENT13","mun","TRABAJO","SEMANA",
           "AUTOS_GT1","AUTOS_2PLUS","TPUBLICO"))
```

## Estructura DAG 1

La estructura de esta DAG tiene una estructura más fuerte en la explicación del uso del transporte público a partir de las variables que describen de manera directa a las personas. La probabilidad de trabajar y la de utilizar el transporte público están directamente relacionadas con las variables de género, edad y nivel socioeconómico. Asimismo, se incluyen variables geográficas que afectan la disponibilidad del transporte, como el tamaño de la localidad, el municipio y la entidad. El hecho de que sea entre semana y de trabajar también afecta la elección de emplear transporte público. Por último, la cantidad de vehículos en el hogar está inversamente relacionada con la demanda de transporte colectivo.

```{r}
arc_set_1 <- matrix(c(
  "MUJER", "TRABAJO",
  "MUJER", "TPUBLICO",
  "EDAD_20_45", "TRABAJO",
  "EDAD_20_45", "TPUBLICO",
  "EDAD_GE60", "TPUBLICO",
  "EDAD_GE60", "AUTOS_GT1",
  "EDAD_GE60", "AUTOS_2PLUS",
  "EDAD_GT30", "AUTOS_GT1",
  "ESTRATO_ALTO", "AUTOS_GT1",
  "ESTRATO_ALTO", "AUTOS_2PLUS",
  "ESTRATO_ALTO", "TPUBLICO",
  "ESTRATO_MA", "AUTOS_GT1",
  "ESTRATO_MA", "AUTOS_2PLUS",
  "LOC_LT15K", "TPUBLICO",
  "LOC_GT100K", "TPUBLICO",
  "ENT13", "TPUBLICO",
  "mun", "TPUBLICO",
  "TRABAJO", "TPUBLICO",
  "SEMANA", "TPUBLICO",
  "AUTOS_GT1", "TPUBLICO",
  "AUTOS_2PLUS", "TPUBLICO"
), byrow = TRUE, ncol = 2, dimnames = list(NULL, c("from","to")))

```

```{r}
print(arc_set_1)
```

## Estructura DAG 2

En el DAG 2, la estructura socioeconómica y territorial reciben más atención. La entidad establece el municipio y las características de la localidad , que a su vez influyen en el acceso al transporte público y a los vehículos. La variable de autos se ve afectada principalmente por las variables del estrato social, y en menor medida el transporte público, la edad, por su parte, es un elemento que altera la relación con ambas. Por otro lado, que se trabaje y que sea entre semana continúan siendo muy importantes para el uso del transporte público.

```{r}
arc_set_2 <- matrix(c(
  "ENT13", "mun",
  "ENT13", "LOC_LT15K",
  "ENT13", "LOC_GT100K",
  "ENT13", "TPUBLICO",
  "mun", "TPUBLICO",
  "LOC_LT15K", "TPUBLICO",
  "LOC_LT15K", "AUTOS_GT1",
  "LOC_GT100K", "TPUBLICO",
  "LOC_GT100K", "AUTOS_GT1",
  "ESTRATO_ALTO", "AUTOS_GT1",
  "ESTRATO_ALTO", "AUTOS_2PLUS",
  "ESTRATO_MA", "AUTOS_GT1",
  "ESTRATO_MA", "AUTOS_2PLUS",
  "MUJER", "TRABAJO",
  "EDAD_20_45", "TRABAJO",
  "EDAD_GE60", "TPUBLICO",
  "EDAD_GT30", "AUTOS_GT1",
  "TRABAJO", "TPUBLICO",
  "SEMANA", "TPUBLICO",
  "AUTOS_GT1", "TPUBLICO",
  "AUTOS_2PLUS", "TPUBLICO"
), byrow = TRUE, ncol = 2, dimnames = list(NULL, c("from","to")))

```

```{r}
print(arc_set_2)
```

## Estructura DAG 3

En la última DAG se toma la idea de las anteriores estructuras que incluye tanto los rasgos individuales como los contextuales. La propiedad de automóviles y el usar el transporte público están directamente relacionadas con el estrato y el tamaño de la localidad, por otro lado, tanto la edad como el género afectan no solo a la variable del transporte, sino también la probabilidad de trabajar. Se mantiene la relación entre ser propietario de un automóvil y el como afecta esto al usar el transporte público, así como la presencia de variables de la localidad, como las entidades y los municipios.

```{r}
arc_set_3 <- matrix(c(
  "ESTRATO_ALTO","AUTOS_GT1",
  "ESTRATO_ALTO","AUTOS_2PLUS",
  "ESTRATO_ALTO","TRABAJO",
  "ESTRATO_MA","AUTOS_GT1",
  "ESTRATO_MA","AUTOS_2PLUS",
  "ESTRATO_MA","TRABAJO",
  "LOC_LT15K","AUTOS_GT1",
  "LOC_LT15K","TRABAJO",
  "LOC_GT100K","AUTOS_GT1",
  "LOC_GT100K","TRABAJO",
  "LOC_GT100K","TPUBLICO",
  "EDAD_20_45","TRABAJO",
  "EDAD_GT30","AUTOS_GT1",
  "EDAD_GE60","AUTOS_GT1",
  "EDAD_GE60","TPUBLICO",
  "MUJER","TPUBLICO",
  "MUJER","TRABAJO",
  "TRABAJO","TPUBLICO",
  "SEMANA","TPUBLICO",
  "AUTOS_GT1","TPUBLICO",
  "AUTOS_2PLUS","TPUBLICO",
  "ENT13","AUTOS_GT1",
  "ENT13","TPUBLICO",
  "mun","AUTOS_GT1",
  "mun","TPUBLICO"
),byrow=TRUE,ncol=2,dimnames=list(NULL,c("from","to")))


```

```{r}
print(arc_set_3)
```

```{r}
arcs(dag1) = arc_set_1
dag1
```

```{r}
arcs(dag2) = arc_set_2
dag2
```

```{r}
arcs(dag3) = arc_set_3
dag3
```

> Construir Red Bayesiana Utilizando la Dag

```{r}
bn_mle_1 = bn.fit(dag1, data = data_dag, method = "mle")
```

```{r}
bn_mle_2 = bn.fit(dag2, data = data_dag, method = "mle")

```

```{r}
bn_mle_3 = bn.fit(dag3, data = data_dag, method = "mle")

```

## Dependencia de los Nodos

> DAG 1

En el DAG 1, las relaciones de dependencia más relevantes son las que apuntan al uso del transporte público, pues tienen valores de 1.0, lo cual indica vínculos muy sólidos. Se destacan elementos como el género femenino, la edad de 20 a 45 años, la condición laboral, los días de la semana y la tenencia de vehículos. Estas dependencias demuestran que el transporte público está condicionado por varios factores. Por el contrario, relaciones como la de ser mayor de 30 años o pertenecer a un estrato medio contribuyen con una dependencia mínima, lo que indica que no siempre son relevantes dentro del modelo.

```{r}
arc.strength(dag1, data = data_dag, criterion = "mi")
```

> DAG 2

En el DAG 2, las dependencias más importantes están centradas en los ámbitos del trabajo y los de la localidad. Las conexiones hacia el transporte público, desde "ENT13", municipio y localidades pequeñas o grandes, así como de trabajo y semana, tienen valores de 1.0. Esto indica que la utilización de este servicio está más determinada por las dinámicas laborales y el contexto territorial que por la edad o el sexo. En cambio, para las personas de más de 30 años y del estrato medio/alto hacia los autos, la fuerza es nula o muy baja, lo que señala que su relevancia es poca. En pocas palabras la localidad de la persona es un factor clave en la estructura de esta DAG.

```{r}
arc.strength(dag2, data = data_dag, criterion = "mi")
```

> DAG 3

En el DAG 3, la importancia de las dependencias se encuentra muy bien estructurada entre elementos individuales y contextuales. Factores como la edad , tener un trabajo, los días laborables, el tamaño del lugar, el municipio y la entidad tienen una influencia significativa en el transporte público, todos con valores de 1.0. Por otro lado, el tener algún vehículo muestra impactos moderados, el grupo de personas mayores de 60 años y las localidades con menos de 15 mil habitantes son significativas, pero los estratos alto y medio no contribuyen. Por lo tanto, este modelo muestra que la edad y todas las variables relacionadas con el entorno son importantes.

```{r}
arc.strength(dag3, data = data_dag, criterion = "mi")
```

## **Bayesian Information Criterion**

```{r}
score(dag1, data = data_dag, type = "bic")
```

```{r}
score(dag2, data = data_dag, type = "bic")
```

```{r}
score(dag3, data = data_dag, type = "bic")
```

Al realizar un BIC, la DAG que mostró mejores resultados es la DAG 2 es decir es la que mejor se ajusta a los datos. Fue la más adecuada porque en el DAG 2 las variables que giran alrededor de la persona y las condiciones de movilidad laboral fueron donde recayeron las dependencias más potentes. Estos son precisamente los elementos que explican en mayor medida el uso del transporte público y la posesión de vehículos privados en los datos.

## Graficación de las DAG

```{r}
library(BiocManager)
library(Rgraphviz)
```

> Dag1

```{r}
graphviz.plot(dag1, shape = "ellipse")
```

> Dag 2

```{r}
graphviz.plot(dag2, shape = "ellipse")
```

> Dag 3

```{r}
graphviz.plot(dag3, shape = "ellipse")
```

## Hill Climbing

```{r}
best_dag = hc(data_dag)
```

```{r}
modelstring(best_dag)
```

```{r}
score(best_dag, data = data_dag, type = "bic")
```

## Estructura de la mejor DAG

```{r}
graphviz.plot(best_dag, shape = "ellipse")
```

```{r}
arc.strength(best_dag, data = data_dag, criterion = "mi")
```

> > En la DAG final podemos ver algunos arcos tienen coherencia y deben mantenerse, como la conexión entre el uso de transporte público en los días de Lunes a Viernes otro arco que hace mucho sentido son los del estrato con el trabajo. Aun así hay otros aspectos que no hacen mucha coherencia como el arco entre los autos y la edad. Además se debe mencionar que hay una gran cantidad de arcos débiles , quiza sea por el sobreajuste.

```{r}
bn = bn.fit(best_dag, data = data_dag)
```

> ### **Query 1**
>
> > |  |
> > |------------------------------------------------------------------------|
> > | ¿Qué tan probable es que una persona viaje entre semana a su trabajo utilizando el transporte público dado que se trata de  mujer entre 20 a 45 años en el estrato sociodemográfico alto? |

```{r}
cpquery(bn, 
        event = (TPUBLICO == "1"), 
        evidence = ((MUJER == "1") & (EDAD_20_45 == "1") & (ESTRATO_ALTO == "1") & (SEMANA == "1") & (TRABAJO == "1")), 
        n = 10^6)
```

### **Query 2**

> ¿Cuál es la probabilidad de usar un medio de transporte público al transportarse dado que el tamaño de la localidad es menor a 15,000 habitantes y la edad es mayor o igual a 60 años?

```{r}
cpquery(bn, 
        event = (TPUBLICO == "1"), 
        evidence = ((LOC_LT15K == "1") & (EDAD_GE60 == "1")), 
        n = 10^6)

```

### **Query 3**

> ¿Cuál es la probabilidad de que una persona de estrato medio/alto que vive en una localidad de más de 100,000 habitantes tenga 2 autos o camionetas?

```{r}
cpquery(bn, 
        event = (AUTOS_2PLUS == "1"), 
        evidence = ((ESTRATO_ALTO == "1" | ESTRATO_MA == "1") & (LOC_GT100K == "1")), 
        n = 10^6)

```

### **Query 4**

> ¿Qué tan probable es que alguien del municipio 97 de la entidad 14 tenga más de un carro y sea una mujer dado que tenga más de 30 años y viaje entre semana a su trabajo?

Debido a que no hay ninguna persona que sea del municipio 97 ni la entidad 14 en nuestra base de datos final se cambiaron por el municipio 69 y entidad 13.

```{r}
cpquery(bn, 
        event = ((AUTOS_GT1 == "1") & (MUJER == "1")), 
        evidence = ((EDAD_GT30 == "1") & (TRABAJO == "1") & (SEMANA == "1") & (mun == "69") & (ENT13 == "1")), 
        n = 10^6)

```
